<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrono Time Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3a86ff;
            --primary-dark: #0a66c2;
            --secondary: #ff006e;
            --background: #f8f9fa;
            --surface: #ffffff;
            --text: #212529;
            --text-light: #6c757d;
            --success: #38b000;
            --danger: #d00000;
            --border-radius: 12px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --font-heading: 'DM Sans', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-body);
        }

        body {
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;  /* Keep this the same */
        }

        /*
        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var (--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-family: var(--font-heading);
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        */

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px; /* Increased gap for better spacing */
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
        }

        .tab {
            padding: 15px 30px; /* Increased padding for larger buttons */
            background-color: var(--surface);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 2px solid transparent;
            font-family: var(--font-heading);
            font-size: 1.1rem; /* Slightly larger font size */
            letter-spacing: -0.01em;
            color: var(--text);
            text-align: center;
            min-width: 180px;
        }

        .tab.active {
            border-color: var(--primary);
            color: var(--primary);
            background-color: rgba(58, 134, 255, 0.1); /* Subtle background for active tab */
        }

        .tab:hover:not(.active) {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .app-section {
            display: none;
            background-color: var(--surface);
            border-radius: var(--border-radius);
            padding: 40px; /* Increased padding */
            box-shadow: var(--shadow);
            margin-bottom: 40px;
        }

        .app-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stopwatch styling */
        .stopwatch-display {
            font-size: 5rem;
            font-weight: 700;
            text-align: center;
            margin: 40px 0;
            padding: 30px 0;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
            color: var(--text);
            font-family: var(--font-heading);
            background: rgba(255, 255, 255, 0.5);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .milliseconds {
            font-size: 2rem;
            color: var(--text-light);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
        }

        .controls .btn {
            padding: 20px 40px;
            min-width: 140px;
            font-size: 1.1rem;
            height: 70px; /* Fixed height for square appearance */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn {
            padding: 15px 30px; /* Larger buttons */
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            font-size: 1rem;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: white;
            color: var(--text);
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background-color: #f1f3f5;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #9d0208;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #2d9300;
            transform: translateY(-2px);
        }

        .btn-reset-icon {
            font-size: 1.8rem;
        }

        .laps-container {
            margin-top: 20px;
        }

        .laps-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }

        .lap-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .lap-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f5;
            transition: var (--transition);
        }

        .lap-item:hover {
            background-color: #f8f9fa;
        }

        .lap-number {
            font-weight: 600;
        }

        .lap-time {
            font-variant-numeric: tabular-nums;
        }

        .lap-times {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lap-diff {
            font-size: 0.85em;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .lap-diff.slower {
            color: var(--danger);
            background-color: rgba(208, 0, 0, 0.1);
        }

        .lap-diff.faster {
            color: var(--success);
            background-color: rgba(56, 176, 0, 0.1);
        }

        /* Train Timer styling */
        .train-container {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            padding: 30px 20px; /* Increased top/bottom padding */
            margin-bottom: 30px;
            position: relative;
        }

        .train {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0 30px 0; /* Adjusted padding */
            margin-bottom: 20px;
            align-items: center;
        }

        .engine {
            width: 120px;
            height: 80px;
            background-color: var(--secondary);
            border-radius: var(--border-radius);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .engine:after {
            content: "";
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: var(--secondary);
            bottom: -15px;
            left: 45px;
            border-radius: 50%;
        }

        .coach {
            width: 100px;
            height: 70px;
            background-color: var(--primary);
            border-radius: var(--border-radius);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            padding: 5px;
            cursor: pointer;
            transition: var(--transition);
        }

        .coach:after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: var(--primary);
            bottom: -10px;
            left: 40px;
            border-radius: 50%;
        }

        .coach:hover {
            transform: translateY(-5px);
        }

        .coach.active {
            background-color: var(--success);
            transform: translateY(-5px);
        }

        .coach.active:after {
            background-color: var(--success);
        }

        .coach-time {
            font-size: 1.2rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .coach-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .add-coach {
            width: 70px;
            height: 70px;
            border: 2px dashed var(--text-light);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .add-coach:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-3px);
        }

        .train-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px; /* Adjusted margin */
        }

        .train-options {
            display: flex;
            justify-content: center;
            margin-bottom: 25px; /* Adjusted margin */
        }

        .loop-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .loop-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-light);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }

        .loop-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .loop-checkbox:checked:after {
            content: "✓";
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        .coach-time-input {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .coach-time-input > div {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .time-input {
            width: 70px;
            padding: 10px;
            text-align: center;
            font-size: 1.1rem;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            appearance: none;
        }

        .time-input::-webkit-inner-spin-button {
            width: 24px;
            height: 24px;
            margin-right: 4px;
            opacity: 1;
        }

        .add-train-btn {
            margin: 30px auto;
            background-color: transparent;
            border: 2px dashed var(--text-light);
            color: var(--text-light);
            padding: 15px 30px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var (--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: fit-content;
            font-size: 1.1rem;
        }

        /* Responsive styling */
        @media (max-width: 768px) {

            .milliseconds {
                font-size: 1.5rem;
            }

            .controls {
                flex-wrap: wrap;
                gap: 15px;
            }

            .controls .btn {
                padding: 15px 30px;
                min-width: 120px;
                height: 60px;
                font-size: 1rem;
            }

            .stopwatch-display {
                font-size: 4rem;
                margin: 30px 0;
                padding: 20px 0;
            }

            .engine {
                width: 100px;
                height: 70px;
            }

            .engine:after {
                width: 25px;
                height: 25px;
                bottom: -12px;
                left: 37px;
            }

            .coach {
                width: 90px;
                height: 60px;
            }

            .coach:after {
                width: 18px;
                height: 18px;
                bottom: -9px;
                left: 36px;
            }
        }

        @media (max-width: 480px) {
            .stopwatch-display {
                font-size: 3rem;
                margin: 20px 0;
            }

            .controls {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
            }

            .controls .btn {
                flex: 1;
                min-width: 100px;
                height: 50px;
            }

            .milliseconds {
                font-size: 1.2rem;
            }

            .tabs {
                flex-direction: column;
                width: 100%;
            }

            .tab {
                width: 100%;
                text-align: center;
            }

            .coach-time-input {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Additional flourishes */
        .coach.completed {
            background-color: var(--text-light);
            opacity: 0.7;
        }

        .coach.completed:after {
            background-color: var(--text-light);
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .train-name {
            font-weight: 500;
            margin: 10px 0 30px 0; /* Adjusted margins for better vertical spacing */
            color: var(--primary);
            font-family: var(--font-heading);
            letter-spacing: -0.01em;
            font-size: 1.5rem;
            text-align: center; /* Center align the text */
        }

        .remove-coach {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: var(--transition);
        }

        .coach:hover .remove-coach {
            opacity: 1;
        }

        .edit-coach-time {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 20px;
            height: 20px;
            background-color: var(--primary-dark);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: var(--transition);
        }

        .coach:hover .edit-coach-time {
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--surface);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-title {
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-family: var(--font-heading);
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-buttons .btn {
            padding: 12px 30px;
            min-width: 100px;
        }

        .train-container {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .remove-train {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 35px; /* Increased from 30px */
            height: 35px; /* Increased from 30px */
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px; /* Increased from 16px */
            cursor: pointer;
            opacity: 0.7;
            transition: var(--transition);
        }

        .remove-train:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px; /* Slightly larger button */
            height: 50px;
            border-radius: 50%;
            background: var(--surface);
            border: 2px solid #dee2e6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* Larger icon */
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .quick-time-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .quick-time {
            padding: 8px 12px;
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            min-width: 45px;
        }

        .quick-time:hover {
            background-color: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .quick-time-section {
            margin-top: 20px;
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
        }

        .quick-time-label {
            font-size: 0.9rem;
            color: var (--text-light);
            margin-bottom: 10px;
        }

        .quick-time-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .quick-time {
            padding: 10px 15px;
            min-width: 60px;
        }

        /* Update the controls button styling */

        /* Add specific styling for reset button */
        .controls .btn-danger {
            width: 60px;  /* Make width and height equal for circle */
            height: 60px;
            min-width: unset;
            padding: 0;
            border-radius: 50%;  /* Make it circular */
            font-size: 1.1rem;
        }

        /* Style reset icon/text */
        .btn-reset-icon {
            font-size: 1.8rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls .btn-danger {
                width: 50px;
                height: 50px;
            }
            
            .btn-reset-icon {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .controls .btn-danger {
                width: 45px;
                height: 45px;
            }
            
            .btn-reset-icon {
                font-size: 1.3rem;
            }
        }

        /* Add these styles to your CSS */
        .loop-button {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: rgba(56, 176, 0, 0.1);
            color: var(--success);
        }

        .loop-button.active {
            background-color: rgba(208, 0, 0, 0.1);
            color: var (--danger);
        }

        .loop-button:hover {
            transform: translateY(-2px);
        }

        /* Update the train-options styling */
        .train-options {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        /* Update the loop button styling */
        .loop-button {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: rgba(56, 176, 0, 0.1);
            color: var(--success);
            margin: 0 auto; /* Add this line for centering */
            display: inline-flex; /* Change to inline-flex */
            align-items: center;
            justify-content: center;
            min-width: 120px; /* Add minimum width for better appearance */
        }

        /* Add color styling for each time unit */
        #hours {
            color: var(--secondary); /* Pink color from train coach */
        }

        #minutes {
            color: var(--success); /* Green color from success state */
        }

        #seconds {
            color: var(--primary); /* Blue color from train coach */
        }

        /* Style the colons between numbers */
        .stopwatch-display .separator {
            color: var(--text);
        }
    </style>
</head>
<body>
    <!-- comment out this entire header section -->
    <!--
    <header>
        <h1>Chrono Time Manager</h1>
    </header>
    -->

    <div class="tabs">
        <div class="tab active" data-tab="stopwatch">Stopwatch</div>
        <div class="tab" data-tab="train-timer">Train Timer</div>
    </div>

    <div class="container">
        <!-- Stopwatch Section -->
        <div class="app-section active" id="stopwatch-section">
            <div class="stopwatch-display">
                <span id="hours">00</span>
                <span class="separator">:</span>
                <span id="minutes">00</span>
                <span class="separator">:</span>
                <span id="seconds">00</span>
                <span class="milliseconds">.<span id="milliseconds">000</span></span>
            </div>

            <div class="controls">
                <button id="start-stop" class="btn btn-primary">Start</button>
                <button id="lap" class="btn btn-secondary" disabled>Lap</button>
                <button id="reset" class="btn btn-danger" disabled>
                    <span class="btn-reset-icon">↺</span>
                </button>
            </div>

            <div class="laps-container">
                <div class="laps-header">
                    <div>Lap</div>
                    <div>Time</div>
                </div>
                <div id="lap-list" class="lap-list"></div>
                <div id="clear-laps" style="text-align: right; margin-top: 15px; display: none;">
                    <button class="btn btn-secondary">Clear Laps</button>
                </div>
            </div>
        </div>

        <!-- Train Timer Section -->
        <div class="app-section" id="train-timer-section">
            <div id="trains-container">
                <div class="train-container" data-train-id="1">
                    <div class="train-name">Time Train #1</div>
                    <div class="train">
                        <div class="engine">ENGINE</div>
                        <div class="add-coach">+</div>
                    </div>
                    <div class="train-options">
                        <button class="loop-button">Enable Loop</button>
                    </div>
                    <div class="train-controls">
                        <button class="btn btn-primary start-train">Start</button>
                        <button class="btn btn-danger reset-train">Reset</button>
                    </div>
                </div>
            </div>

            <button id="add-train" class="add-train-btn">
                <span>+ Add Another Time Train</span>
            </button>
        </div>
    </div>

    <!-- Modal for coach time setting -->
    <div class="modal" id="coach-modal">
        <div class="modal-content">
            <h3 class="modal-title">Set Coach Time</h3>
            <div class="coach-time-input">
                <div>
                    <label for="hours-input">Hours</label>
                    <input type="number" id="hours-input" class="time-input" min="0" max="23" value="0">
                </div>
                <div>
                    <label for="minutes-input">Minutes</label>
                    <input type="number" id="minutes-input" class="time-input" min="0" max="59" value="0">
                </div>
                <div>
                    <label for="seconds-input">Seconds</label>
                    <input type="number" id="seconds-input" class="time-input" min="0" max="59" value="0">
                </div>
            </div>
            <div class="quick-time-section">
                <p class="quick-time-label">Quick Selection:</p>
                <div class="quick-time-buttons">
                    <button class="quick-time" data-minutes="5">5m</button>
                    <button class="quick-time" data-minutes="10">10m</button>
                    <button class="quick-time" data-minutes="15">15m</button>
                    <button class="quick-time" data-minutes="30">30m</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancel-coach">Cancel</button>
                <button class="btn btn-primary" id="save-coach">Save</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const sections = document.querySelectorAll('.app-section');
        const startStopBtn = document.getElementById('start-stop');
        const lapBtn = document.getElementById('lap');
        const resetBtn = document.getElementById('reset');
        const hourDisplay = document.getElementById('hours');
        const minuteDisplay = document.getElementById('minutes');
        const secondDisplay = document.getElementById('seconds');
        const millisecondDisplay = document.getElementById('milliseconds');
        const lapList = document.getElementById('lap-list');
        const clearLapsBtn = document.getElementById('clear-laps');
        const addTrainBtn = document.getElementById('add-train');
        const trainsContainer = document.getElementById('trains-container');
        const coachModal = document.getElementById('coach-modal');
        const hoursInput = document.getElementById('hours-input');
        const minutesInput = document.getElementById('minutes-input');
        const secondsInput = document.getElementById('seconds-input');
        const saveCoachBtn = document.getElementById('save-coach');
        const cancelCoachBtn = document.getElementById('cancel-coach');

        // Tab functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active section
                sections.forEach(section => section.classList.remove('active'));
                document.getElementById(`${tabId}-section`).classList.add('active');
            });
        });

        // Stopwatch functionality
        let stopwatchInterval;
        let startTime;
        let elapsedTime = 0;
        let running = false;
        let laps = [];
        let lapCounter = 1;

        function formatTime(time) {
            const hours = Math.floor(time / 3600000);
            const minutes = Math.floor((time % 3600000) / 60000);
            const seconds = Math.floor((time % 60000) / 1000);
            const milliseconds = time % 1000;

            return {
                hours: hours.toString().padStart(2, '0'),
                minutes: minutes.toString().padStart(2, '0'),
                seconds: seconds.toString().padStart(2, '0'),
                milliseconds: milliseconds.toString().padStart(3, '0')
            };
        }

        function updateStopwatchDisplay() {
            const timeNow = Date.now();
            const timeToDisplay = elapsedTime + (running ? timeNow - startTime : 0);
            const formattedTime = formatTime(timeToDisplay);

            hourDisplay.textContent = formattedTime.hours;
            minuteDisplay.textContent = formattedTime.minutes;
            secondDisplay.textContent = formattedTime.seconds;
            millisecondDisplay.textContent = formattedTime.milliseconds;
        }

        function startStopwatch() {
            if (!running) {
                startTime = Date.now();
                stopwatchInterval = setInterval(updateStopwatchDisplay, 10);
                startStopBtn.textContent = 'Pause';
                startStopBtn.classList.remove('btn-primary');
                startStopBtn.classList.add('btn-success');
                running = true;
                lapBtn.disabled = false;
                resetBtn.disabled = false;
            } else {
                clearInterval(stopwatchInterval);
                elapsedTime += Date.now() - startTime;
                startStopBtn.textContent = 'Resume';
                startStopBtn.classList.remove('btn-success');
                startStopBtn.classList.add('btn-primary');
                running = false;
            }
        }

        function resetStopwatch() {
            clearInterval(stopwatchInterval);
            elapsedTime = 0;
            startTime = 0;
            running = false;
            updateStopwatchDisplay();
            startStopBtn.textContent = 'Start';
            startStopBtn.classList.remove('btn-success');
            startStopBtn.classList.add('btn-primary');
            lapBtn.disabled = true;
            resetBtn.disabled = true;
        }

        function recordLap() {
            if (running) {
                const timeNow = Date.now();
                const lapTime = elapsedTime + (timeNow - startTime);
                laps.push(lapTime);
                
                const formattedTime = formatTime(lapTime);
                const lapTimeString = `${formattedTime.hours}:${formattedTime.minutes}:${formattedTime.seconds}.${formattedTime.milliseconds}`;
                
                // Calculate difference from previous lap
                let diffString = '';
                if (laps.length > 1) {
                    const timeDiff = lapTime - laps[laps.length - 2];
                    const formattedDiff = formatTime(Math.abs(timeDiff));
                    const sign = timeDiff >= 0 ? '+' : '-';
                    diffString = `<span class="lap-diff ${timeDiff >= 0 ? 'slower' : 'faster'}">${sign}${formattedDiff.hours}:${formattedDiff.minutes}:${formattedDiff.seconds}.${formattedDiff.milliseconds}</span>`;
                }
                
                const lapItem = document.createElement('div');
                lapItem.className = 'lap-item';
                lapItem.innerHTML = `
                    <div class="lap-number">Lap ${lapCounter}</div>
                    <div class="lap-times">
                        <div class="lap-time">${lapTimeString}</div>
                        ${diffString}
                    </div>
                `;
                
                lapList.prepend(lapItem);
                lapCounter++;
                
                clearLapsBtn.style.display = 'block';
            }
        }

        function clearLaps() {
            lapList.innerHTML = '';
            laps = [];
            lapCounter = 1;
            clearLapsBtn.style.display = 'none';
        }

        // Event listeners for stopwatch
        startStopBtn.addEventListener('click', startStopwatch);
        lapBtn.addEventListener('click', recordLap);
        resetBtn.addEventListener('click', resetStopwatch);
        clearLapsBtn.querySelector('button').addEventListener('click', clearLaps);

        // Train Timer functionality
        let trainCounter = 1;
        const trainTimers = {};

        function createCoach(trainId, hours = 0, minutes = 5, seconds = 0) {
            const train = document.querySelector(`.train-container[data-train-id="${trainId}"] .train`);
            const addCoachBtn = train.querySelector('.add-coach');
            
            const coach = document.createElement('div');
            coach.className = 'coach';
            
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;
            coach.dataset.totalSeconds = totalSeconds;
            coach.dataset.initialSeconds = totalSeconds;
            
            const formattedHours = hours.toString().padStart(2, '0');
            const formattedMinutes = minutes.toString().padStart(2, '0');
            const formattedSeconds = seconds.toString().padStart(2, '0');
            
            coach.innerHTML = `
                <div class="coach-time">${formattedHours}:${formattedMinutes}:${formattedSeconds}</div>
                <div class="coach-label">Coach ${train.querySelectorAll('.coach').length + 1}</div>
                <div class="remove-coach">×</div>
                <div class="edit-coach-time">✎</div>
            `;
            
            train.insertBefore(coach, addCoachBtn);
            
            
            // Add event listeners for the coach
            const removeBtn = coach.querySelector('.remove-coach');
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                coach.remove();
                updateCoachLabels(trainId);
            });
            
            const editBtn = coach.querySelector('.edit-coach-time');
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openCoachModal(coach);
            });
            
            updateCoachLabels(trainId);
        }

        function updateCoachLabels(trainId) {
            const train = document.querySelector(`.train-container[data-train-id="${trainId}"] .train`);
            const coaches = train.querySelectorAll('.coach');
            
            coaches.forEach((coach, index) => {
                const label = coach.querySelector('.coach-label');
                label.textContent = `Coach ${index + 1}`;
            });
        }

        function formatTimeFromSeconds(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return {
                hours: hours.toString().padStart(2, '0'),
                minutes: minutes.toString().padStart(2, '0'),
                seconds: seconds.toString().padStart(2, '0')
            };
        }

        function updateCoachDisplay(coach, totalSeconds) {
            const time = formatTimeFromSeconds(totalSeconds);
            coach.querySelector('.coach-time').textContent = `${time.hours}:${time.minutes}:${time.seconds}`;
            coach.dataset.totalSeconds = totalSeconds;
        }

        function startTrainTimer(trainId) {
            const trainContainer = document.querySelector(`.train-container[data-train-id="${trainId}"]`);
            const startBtn = trainContainer.querySelector('.start-train');
            const resetBtn = trainContainer.querySelector('.reset-train');
            const coaches = Array.from(trainContainer.querySelectorAll('.coach'));
            
            if (coaches.length === 0) {
                alert('Please add at least one coach to start the timer!');
                return;
            }
            
            if (trainTimers[trainId]?.running) {
                // Pause the timer
                clearInterval(trainTimers[trainId].interval);
                trainTimers[trainId].running = false;
                startBtn.textContent = 'Resume';
                startBtn.classList.remove('btn-success');
                startBtn.classList.add('btn-primary');
            } else {
                // Start or resume the timer
                let currentCoachIndex = trainTimers[trainId]?.currentCoachIndex || 0;
                
                // Reset completed status on coaches
                if (!trainTimers[trainId]) {
                    coaches.forEach(coach => coach.classList.remove('active', 'completed'));
                    coaches[0].classList.add('active');
                }
                
                const updateTimer = () => {
                    if (currentCoachIndex >= coaches.length) {
                        // All coaches completed
                        if (isLoopEnabled(trainId)) { // Pass trainId to the function
                            // Reset and loop
                            coaches.forEach(coach => {
                                coach.classList.remove('active', 'completed');
                                const initialSeconds = parseInt(coach.dataset.initialSeconds);
                                updateCoachDisplay(coach, initialSeconds);
                            });
                            currentCoachIndex = 0;
                            coaches[0].classList.add('active');
                        } else {
                            // Stop the timer
                            clearInterval(trainTimers[trainId].interval);
                            trainTimers[trainId].running = false;
                            startBtn.textContent = 'Start';
                            startBtn.classList.remove('btn-success');
                            startBtn.classList.add('btn-primary');
                            return;
                        }
                    }
                    
                    const currentCoach = coaches[currentCoachIndex];
                    let remainingSeconds = parseInt(currentCoach.dataset.totalSeconds);
                    
                    if (remainingSeconds <= 0) {
                        // Current coach timer complete
                        currentCoach.classList.remove('active');
                        currentCoach.classList.add('completed');
                        currentCoachIndex++;
                        
                        if (currentCoachIndex < coaches.length) {
                            // Move to next coach
                            coaches[currentCoachIndex].classList.add('active');
                        }
                        return;
                    }
                    
                    // Update current coach time
                    remainingSeconds--;
                    updateCoachDisplay(currentCoach, remainingSeconds);
                    
                    // Pulse effect when close to zero
                    if (remainingSeconds <= 5) {
                        currentCoach.classList.add('pulse');
                    } else {
                        currentCoach.classList.remove('pulse');
                    }
                };
                
                // Start the interval
                trainTimers[trainId] = {
                    interval: setInterval(updateTimer, 1000),
                    running: true,
                    currentCoachIndex: currentCoachIndex
                };
                
                startBtn.textContent = 'Pause';
                startBtn.classList.remove('btn-primary');
                startBtn.classList.add('btn-success');
                
                // Call immediately to update display
                updateTimer();
            }
        }

        function resetTrainTimer(trainId) {
            const trainContainer = document.querySelector(`.train-container[data-train-id="${trainId}"]`);
            const startBtn = trainContainer.querySelector('.start-train');
            const coaches = Array.from(trainContainer.querySelectorAll('.coach'));
            
            // Clear interval if running
            if (trainTimers[trainId]?.interval) {
                clearInterval(trainTimers[trainId].interval);
            }
            
            // Reset all coaches
            coaches.forEach(coach => {
                coach.classList.remove('active', 'completed', 'pulse');
                const initialSeconds = parseInt(coach.dataset.initialSeconds);
                updateCoachDisplay(coach, initialSeconds);
            });
            
            // Reset timer state
            trainTimers[trainId] = {
                running: false,
                currentCoachIndex: 0
            };
            
            // Reset button state
            startBtn.textContent = 'Start';
            startBtn.classList.remove('btn-success');
            startBtn.classList.add('btn-primary');
            
            // Set first coach as active if exists
            if (coaches.length > 0) {
                coaches[0].classList.add('active');
            }
        }

        function createTrainTimer() {
            trainCounter++;
            
            const trainContainer = document.createElement('div');
            trainContainer.className = 'train-container';
            trainContainer.dataset.trainId = trainCounter;
            
            trainContainer.innerHTML = `
                <div class="train-name">Time Train #${trainCounter}</div>
                <div class="remove-train">×</div>
                <div class="train">
                    <div class="engine">ENGINE</div>
                    <div class="add-coach">+</div>
                </div>
                <div class="train-options">
                    <button class="loop-button">Enable Loop</button>
                </div>
                <div class="train-controls">
                    <button class="btn btn-primary start-train">Start</button>
                    <button class="btn btn-danger reset-train">Reset</button>
                </div>
            `;
            
            trainsContainer.appendChild(trainContainer);
            
            // Add event listeners for the new train
            setupTrainEventListeners(trainContainer);
        }

        // Update the setupTrainEventListeners function to properly handle the loop functionality
        function setupTrainEventListeners(trainContainer) {
            const trainId = trainContainer.dataset.trainId;
            const addCoachBtn = trainContainer.querySelector('.add-coach');
            const startBtn = trainContainer.querySelector('.start-train');
            const resetBtn = trainContainer.querySelector('.reset-train');
            const removeTrainBtn = trainContainer.querySelector('.remove-train');
            const loopBtn = trainContainer.querySelector('.loop-button');
            
            // Add loop button click handler
            loopBtn.addEventListener('click', () => {
                loopBtn.classList.toggle('active');
                const isActive = loopBtn.classList.contains('active');
                loopBtn.textContent = isActive ? 'Disable Loop' : 'Enable Loop';
                loopBtn.style.backgroundColor = isActive ? 'rgba(208, 0, 0, 0.1)' : 'rgba(56, 176, 0, 0.1)';
                loopBtn.style.color = isActive ? 'var(--danger)' : 'var(--success)';
            });
            
            // ... rest of the event listeners
        }

        // Create a separate function to check loop status
        function isLoopEnabled(trainId) {
            const trainContainer = document.querySelector(`.train-container[data-train-id="${trainId}"]`);
            const loopButton = trainContainer.querySelector('.loop-button');
            return loopButton.classList.contains('active');
        }

        // Update the updateTimer function in startTrainTimer
        function startTrainTimer(trainId) {
            const trainContainer = document.querySelector(`.train-container[data-train-id="${trainId}"]`);
            const startBtn = trainContainer.querySelector('.start-train');
            const resetBtn = trainContainer.querySelector('.reset-train');
            const coaches = Array.from(trainContainer.querySelectorAll('.coach'));
            
            if (coaches.length === 0) {
                alert('Please add at least one coach to start the timer!');
                return;
            }
            
            if (trainTimers[trainId]?.running) {
                // Pause the timer
                clearInterval(trainTimers[trainId].interval);
                trainTimers[trainId].running = false;
                startBtn.textContent = 'Resume';
                startBtn.classList.remove('btn-success');
                startBtn.classList.add('btn-primary');
            } else {
                // Start or resume the timer
                let currentCoachIndex = trainTimers[trainId]?.currentCoachIndex || 0;
                
                // Reset completed status on coaches
                if (!trainTimers[trainId]) {
                    coaches.forEach(coach => coach.classList.remove('active', 'completed'));
                    coaches[0].classList.add('active');
                }
                
                const updateTimer = () => {
                    if (currentCoachIndex >= coaches.length) {
                        // All coaches completed
                        if (isLoopEnabled(trainId)) {
                            // Reset and loop
                            coaches.forEach(coach => {
                                coach.classList.remove('active', 'completed', 'pulse');
                                const initialSeconds = parseInt(coach.dataset.initialSeconds);
                                coach.dataset.totalSeconds = initialSeconds;
                                updateCoachDisplay(coach, initialSeconds);
                            });
                            currentCoachIndex = 0;
                            coaches[0].classList.add('active');
                            return updateTimer(); // Call immediately to start the next cycle
                        } else {
                            // Stop the timer
                            clearInterval(trainTimers[trainId].interval);
                            trainTimers[trainId].running = false;
                            startBtn.textContent = 'Start';
                            startBtn.classList.remove('btn-success');
                            startBtn.classList.add('btn-primary');
                            return;
                        }
                    }
                    
                    const currentCoach = coaches[currentCoachIndex];
                    let remainingSeconds = parseInt(currentCoach.dataset.totalSeconds);
                    
                    if (remainingSeconds <= 0) {
                        // Current coach timer complete
                        currentCoach.classList.remove('active');
                        currentCoach.classList.add('completed');
                        currentCoachIndex++;
                        
                        if (currentCoachIndex < coaches.length) {
                            // Move to next coach
                            coaches[currentCoachIndex].classList.add('active');
                        }
                        return;
                    }
                    
                    // Update current coach time
                    remainingSeconds--;
                    updateCoachDisplay(currentCoach, remainingSeconds);
                    
                    // Pulse effect when close to zero
                    if (remainingSeconds <= 5) {
                        currentCoach.classList.add('pulse');
                    } else {
                        currentCoach.classList.remove('pulse');
                    }
                };
                
                // Start the interval
                trainTimers[trainId] = {
                    interval: setInterval(updateTimer, 1000),
                    running: true,
                    currentCoachIndex: currentCoachIndex
                };
                
                startBtn.textContent = 'Pause';
                startBtn.classList.remove('btn-primary');
                startBtn.classList.add('btn-success');
                
                // Call immediately to update display
                updateTimer();
            }
        }

        function setupTrainEventListeners(trainContainer) {
            const trainId = trainContainer.dataset.trainId;
            const addCoachBtn = trainContainer.querySelector('.add-coach');
            const startBtn = trainContainer.querySelector('.start-train');
            const resetBtn = trainContainer.querySelector('.reset-train');
            const removeTrainBtn = trainContainer.querySelector('.remove-train');
            const loopBtn = trainContainer.querySelector('.loop-button');
            
            // Add loop button click handler
            loopBtn.addEventListener('click', () => {
                loopBtn.classList.toggle('active');
                const isActive = loopBtn.classList.contains('active');
                loopBtn.textContent = isActive ? 'Disable Loop' : 'Enable Loop';
                // Optional: Add visual feedback
                loopBtn.style.backgroundColor = isActive ? 'rgba(208, 0, 0, 0.1)' : 'rgba(56, 176, 0, 0.1)';
                loopBtn.style.color = isActive ? 'var(--danger)' : 'var(--success)';
            });

            // Update the startTrainTimer function to use the button instead of checkbox
            function isLoopEnabled(trainId) {
                const trainContainer = document.querySelector(`.train-container[data-train-id="${trainId}"]`);
                const loopButton = trainContainer.querySelector('.loop-button');
                return loopButton.classList.contains('active');
            }

            addCoachBtn.addEventListener('click', () => {
                openCoachModal(null, trainId);
            });
            
            startBtn.addEventListener('click', () => {
                startTrainTimer(trainId);
            });
            
            resetBtn.addEventListener('click', () => {
                resetTrainTimer(trainId);
            });
            
            removeTrainBtn.addEventListener('click', () => {
                // Stop timer if running
                if (trainTimers[trainId]?.interval) {
                    clearInterval(trainTimers[trainId].interval);
                    delete trainTimers[trainId];
                }
                
                trainContainer.remove();
            });
        }

        // Modify the openCoachModal function
        function openCoachModal(coach = null, trainId = null) {
            // Set modal state
            coachModal.dataset.coach = coach ? coach.outerHTML : '';
            coachModal.dataset.trainId = trainId || (coach ? coach.closest('.train-container').dataset.trainId : '');
            
            if (coach) {
                const totalSeconds = parseInt(coach.dataset.totalSeconds);
                const time = formatTimeFromSeconds(totalSeconds);
                hoursInput.value = parseInt(time.hours);
                minutesInput.value = parseInt(time.minutes);
                secondsInput.value = parseInt(time.seconds);
            } else {
                // Default values for new coach - all set to 0
                hoursInput.value = 0;
                minutesInput.value = 0;
                secondsInput.value = 0;
            }
            
            // Show modal
            coachModal.classList.add('active');
        }

        function closeCoachModal() {
            coachModal.classList.remove('active');
        }

        function saveCoachTime() {
            const hours = parseInt(hoursInput.value) || 0;
            const minutes = parseInt(minutesInput.value) || 0;
            const seconds = parseInt(secondsInput.value) || 0;
            
            const trainId = coachModal.dataset.trainId;
            const coachHTML = coachModal.dataset.coach;
            
            if (coachHTML) {
                // Editing existing coach
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = coachHTML;
                const originalCoach = tempDiv.querySelector('.coach');
                const allCoaches = document.querySelectorAll(`.train-container[data-train-id="${trainId}"] .coach`);
                
                // Find the coach by comparing data attributes and content
                const coach = Array.from(allCoaches).find(c => 
                    c.querySelector('.coach-label').textContent === originalCoach.querySelector('.coach-label').textContent
                );
                
                if (coach) {
                    const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                    updateCoachDisplay(coach, totalSeconds);
                    coach.dataset.initialSeconds = totalSeconds;
                    coach.dataset.totalSeconds = totalSeconds;
                }
            } else {
                // Creating new coach
                createCoach(trainId, hours, minutes, seconds);
            }
            
            closeCoachModal();
        }

        // Add quick time selection functionality
        document.querySelectorAll('.quick-time').forEach(btn => {
            btn.addEventListener('click', () => {
                const minutes = parseInt(btn.dataset.minutes);
                hoursInput.value = Math.floor(minutes / 60);
                minutesInput.value = minutes % 60;
                secondsInput.value = 0;
            });
        });

        // Event listeners for modal
        saveCoachBtn.addEventListener('click', saveCoachTime);
        cancelCoachBtn.addEventListener('click', closeCoachModal);

        // Event listener for add train button
        addTrainBtn.addEventListener('click', createTrainTimer);

        // Setup initial train event listeners
        document.querySelectorAll('.train-container').forEach(trainContainer => {
            setupTrainEventListeners(trainContainer);
        });

        // Initialize the stopwatch display
        updateStopwatchDisplay();

        // Close modal when clicking outside of it
        window.addEventListener('click', (e) => {
            if (e.target === coachModal) {
                closeCoachModal();
            }
        });

        // Handle numeric input validation
        document.querySelectorAll('.time-input').forEach(input => {
            input.addEventListener('input', function() {
                const min = parseInt(this.min) || 0;
                const max = parseInt(this.max) || Infinity;
                let value = parseInt(this.value) || 0;
                
                if (value < min) value = min;
                if (value > max) value = max;
                
                this.value = value;
            });
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('stopwatch-section').classList.contains('active')) {
                // Stopwatch shortcuts
                if (e.code === 'Space') {
                    e.preventDefault();
                    startStopwatch();
                } else if (e.code === 'KeyL') {
                    if (!lapBtn.disabled) {
                        recordLap();
                    }
                } else if (e.code === 'KeyR') {
                    if (!resetBtn.disabled) {
                        resetStopwatch();
                    }
                }
            }
        });

        // Add swipe gestures for mobile
        let touchStartX = 0;
        let touchEndX = 0;
        
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
        
        function handleSwipe() {
            const swipeThreshold = 100;
            const currentTabIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
            
            if (touchEndX < touchStartX - swipeThreshold) {
                // Swipe left - next tab
                const nextTab = tabs[Math.min(currentTabIndex + 1, tabs.length - 1)];
                if (nextTab) nextTab.click();
            } else if (touchEndX > touchStartX + swipeThreshold) {
                // Swipe right - previous tab
                const prevTab = tabs[Math.max(currentTabIndex - 1, 0)];
                if (prevTab) prevTab.click();
            }
        }
        
        // Add theme toggle (light/dark mode)
        const themeToggle = document.createElement('div');
        themeToggle.style.position = 'fixed';
        themeToggle.style.top = '20px';
        themeToggle.style.right = '20px';
        themeToggle.style.width = '40px';
        themeToggle.style.height = '40px';
        themeToggle.style.borderRadius = '50%';
        themeToggle.style.background = '#f1f3f5';
        themeToggle.style.border = '2px solid #dee2e6';
        themeToggle.style.cursor = 'pointer';
        themeToggle.style.display = 'flex';
        themeToggle.style.alignItems = 'center';
        themeToggle.style.justifyContent = 'center';
        themeToggle.innerHTML = '☀️';
        themeToggle.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
        themeToggle.style.zIndex = '100';
        document.body.appendChild(themeToggle);

        let darkMode = false;
        themeToggle.addEventListener('click', () => {
            darkMode = !darkMode;
            if (darkMode) {
                document.documentElement.style.setProperty('--background', '#121212');
                document.documentElement.style.setProperty('--surface', '#1e1e1e');
                document.documentElement.style.setProperty('--text', '#e0e0e0');
                document.documentElement.style.setProperty('--text-light', '#a0a0a0');
                themeToggle.innerHTML = '🌙';
                themeToggle.style.background = '#2d2d2d';
                themeToggle.style.border = '2px solid #3d3d3d';
            } else {
                document.documentElement.style.setProperty('--background', '#f8f9fa');
                document.documentElement.style.setProperty('--surface', '#ffffff');
                document.documentElement.style.setProperty('--text', '#212529');
                document.documentElement.style.setProperty('--text-light', '#6c757d');
                themeToggle.innerHTML = '☀️';
                themeToggle.style.background = '#f1f3f5';
                themeToggle.style.border = '2px solid #dee2e6';
            }
        });
    </script>
</body>
</html>